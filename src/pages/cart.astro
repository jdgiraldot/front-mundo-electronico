---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import "@/styles/global.css";
import { formatUrl } from "@/utils/url.js";

const catalogUrl = formatUrl("/catalog");
const checkoutUrl = formatUrl("/checkout");
---

<Layout
    title="Carrito"
    description="Revisa los productos en tu carrito de compras."
>
    <Header slot="header" />

    <section class="cart-page">
        <div class="container">
            <h1 class="section-title">Tu Carrito</h1>

            <div id="cart-empty" class="cart-empty" style="display:none;">
                <p class="cart-empty__icon">ðŸ›’</p>
                <p class="cart-empty__text">Tu carrito estÃ¡ vacÃ­o</p>
                <a href={catalogUrl} class="btn btn-primary"
                    >Ver productos</a
                >
            </div>

            <div id="cart-content" style="display:none;">
                <div class="cart-table">
                    <div class="cart-table__header">
                        <span>Producto</span>
                        <span>Precio</span>
                        <span>Cantidad</span>
                        <span>Subtotal</span>
                        <span></span>
                    </div>
                    <div id="cart-items"></div>
                </div>

                <div class="cart-summary">
                    <div class="cart-summary__row">
                        <span>Total:</span>
                        <span class="cart-summary__total" id="cart-total"
                            >$0</span
                        >
                    </div>
                    <a
                        href={checkoutUrl}
                        class="btn btn-primary btn-lg"
                        id="checkout-btn"
                    >
                        Proceder al Checkout â†’
                    </a>
                </div>
            </div>
        </div>
    </section>

    <Footer slot="footer" />
</Layout>

<script>
    import { getCart, updateQuantity, removeFromCart, getCartTotal } from "@/scripts/cartStore.js";
    import { formatUrl } from "@/utils/url.js";

    function formatPrice(value) {
        return new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 }).format(value);
    }

    function renderCart() {
        const cart = getCart();
        const emptyEl = document.getElementById("cart-empty");
        const contentEl = document.getElementById("cart-content");
        const itemsEl = document.getElementById("cart-items");
        const totalEl = document.getElementById("cart-total");

        if (!emptyEl || !contentEl || !itemsEl || !totalEl) return;

        if (cart.length === 0) {
            emptyEl.style.display = "flex";
            contentEl.style.display = "none";
            return;
        }

        emptyEl.style.display = "none";
        contentEl.style.display = "block";

        itemsEl.innerHTML = cart
            .map(
                (item) => `
        <div class="cart-item" data-id="${item.id}">
          <div class="cart-item__product">
            <img src="${item.imageUrl || formatUrl("/placeholder.svg")}" alt="${item.name}" class="cart-item__img" />
            <span class="cart-item__name">${item.name}</span>
          </div>
          <span class="cart-item__price">${formatPrice(item.price)}</span>
          <div class="cart-item__qty">
            <button class="qty-btn" data-action="decrease" data-id="${item.id}">âˆ’</button>
            <span class="qty-value">${item.quantity}</span>
            <button class="qty-btn" data-action="increase" data-id="${item.id}">+</button>
          </div>
          <span class="cart-item__subtotal">${formatPrice(item.price * item.quantity)}</span>
          <button class="cart-item__remove" data-action="remove" data-id="${item.id}" title="Eliminar">âœ•</button>
        </div>
      `,
            )
            .join("");

        totalEl.textContent = formatPrice(getCartTotal());

        // Bind quantity & remove buttons
        itemsEl.querySelectorAll("[data-action]").forEach((btn) => {
            btn.addEventListener("click", () => {
                const productId = Number(btn.dataset.id);
                const action = btn.dataset.action;
                const cartItem = getCart().find((i) => i.id === productId);
                if (!cartItem) return;

                if (action === "increase") {
                    updateQuantity(productId, cartItem.quantity + 1);
                } else if (action === "decrease") {
                    updateQuantity(productId, cartItem.quantity - 1);
                } else if (action === "remove") {
                    removeFromCart(productId);
                }
                renderCart();
            });
        });
    }

    renderCart();
    window.addEventListener("cart-updated", renderCart);
</script>

<style>
    .cart-page {
        padding: var(--space-xl) 0 var(--space-2xl);
    }

    /* Empty cart */
    .cart-empty {
        flex-direction: column;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-2xl);
        text-align: center;
    }

    .cart-empty__icon {
        font-size: 3rem;
        opacity: 0.4;
    }

    .cart-empty__text {
        color: var(--color-text-muted);
        font-size: 1.1rem;
    }

    /* Cart Table */
    .cart-table {
        margin-top: var(--space-xl);
    }

    .cart-table__header {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 40px;
        gap: var(--space-md);
        padding: var(--space-sm) var(--space-md);
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--color-border);
    }

    /* Cart Summary */
    .cart-summary {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: var(--space-xl);
        margin-top: var(--space-xl);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--color-border);
    }

    .cart-summary__row {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        font-size: 1.1rem;
    }

    .cart-summary__total {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--color-primary);
    }

    @media (max-width: 768px) {
        .cart-table__header {
            display: none;
        }
        .cart-summary {
            flex-direction: column;
            align-items: stretch;
        }
        .cart-summary__row {
            justify-content: space-between;
        }
    }
</style>
